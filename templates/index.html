<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Prerequisites</title>
    <script>
        // Fetch subjects and populate the dropdown
        async function fetchSubjects() {
            const response = await fetch("/subject-codes");
            const data = await response.json();

            const subjectDropdown = document.getElementById("subjectDropdown");
            Object.keys(data).forEach(subject => {
                const option = document.createElement("option");
                option.value = data[subject]; // Subject URL
                option.textContent = subject;
                subjectDropdown.appendChild(option);
            });
        }

        // Fetch courses when a subject is selected
        async function fetchCourses() {
            const subjectUrl = document.getElementById("subjectDropdown").value;
            const response = await fetch(`/courses?url=${encodeURIComponent(subjectUrl)}`);
            const data = await response.json();

            const courseDropdown = document.getElementById("courseDropdown");
            courseDropdown.innerHTML = '<option value="" disabled selected>Select a course</option>'; // Clear old options

            if (response.ok) {
                data.forEach(course => {
                    const option = document.createElement("option");
                    option.value = course.url; // Full course URL
                    option.textContent = `${course.name} ${course.number}`;
                    courseDropdown.appendChild(option);
                });
            } else {
                alert(data.error);
            }
        }

        // Fetch courses that list the selected course as a prerequisite
        async function fetchPrerequisiteForCourses() {
            const courseDropdown = document.getElementById("courseDropdown");
            const selectedOption = courseDropdown.options[courseDropdown.selectedIndex];
            const courseUrl = selectedOption.value;
            const courseNumber = selectedOption.text.split(" ").pop(); // Extract course number

            const response = await fetch(`/courses-with-prerequisite?url=${encodeURIComponent(courseUrl)}&number=${courseNumber}`);
            const data = await response.json();

            const resultList = document.getElementById("prerequisiteForList");
            resultList.innerHTML = ""; // Clear previous results

            if (response.ok && data.courses) {
                data.courses.forEach(course => {
                    const listItem = document.createElement("li");
                    listItem.textContent = `${course.name} ${course.number}`;
                    resultList.appendChild(listItem);
                });
            } else {
                resultList.innerHTML = `<li>${data.error || "No courses found that list this as a prerequisite."}</li>`;
            }
        }

        // Initialize subject dropdown on page load
        window.onload = fetchSubjects;
    </script>
</head>
<body>
    <h1>Course Prerequisites</h1>

    <label for="subjectDropdown">Select Course Code:</label>
    <select id="subjectDropdown" onchange="fetchCourses()">
        <option value="" disabled selected>Select a course code</option>
    </select>

    <br><br>

    <label for="courseDropdown">Select Course Number:</label>
    <select id="courseDropdown" onchange="fetchPrerequisiteForCourses()">
        <option value="" disabled selected>Select a course number</option>
    </select>

    <h3>Courses That List This as a Prerequisite:</h3>
    <ul id="prerequisiteForList"></ul>
</body>
</html>
